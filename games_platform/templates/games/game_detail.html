{% extends 'base.html' %}

{% block title %}{{ game.title }}{% endblock %}

{% block content %}
<div class="game-detail">
    <div class="game-header">
        <h1>{{ game.title }}</h1>
        
        {% if user.is_authenticated and user.is_admin %}
        <div class="admin-actions">
            {% if game.status == 'pending' %}
                <a href="{% url 'moderate_game' game.pk 'approve' %}" class="btn btn-success">–û–¥–æ–±—Ä–∏—Ç—å</a>
                <a href="{% url 'moderate_game' game.pk 'reject' %}" class="btn btn-danger">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <div class="game-meta">
        <p><strong>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</strong>
            <a href="{% url 'user_detail' game.developer.pk %}">{{ game.developer.username }}</a>
        </p>
        <p><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong> {{ game.created_at|date:"d.m.Y H:i" }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
            <span class="status-{{ game.status }}">{{ game.get_status_display }}</span>
        </p>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã -->
        <div class="game-stats">
            <span class="stat-item">
                <i class="stat-icon">üëÅÔ∏è</i> {{ game.get_view_count }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            </span>
            <span class="stat-item">
                <i class="stat-icon">üéÆ</i> {{ game.get_play_count }} –∑–∞–ø—É—Å–∫–æ–≤
            </span>
            <span class="stat-item">
                <i class="stat-icon">üí¨</i> {{ game.get_comment_count }} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
            </span>

            {% if average_rating > 0 %}
            <span class="stat-item rating-stat">
                <i class="stat-icon">‚≠ê</i>
                {{ average_rating }} ({{ rating_count }} –æ—Ü–µ–Ω–æ–∫)
            </span>
            {% endif %}
        </div>

        {% if game.published_at %}
            <p><strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</strong> {{ game.published_at|date:"d.m.Y H:i" }}</p>
        {% endif %}
    </div>

    {% if game.thumbnail %}
    <div class="game-thumbnail-large">
        <img src="{{ game.thumbnail.url }}" alt="{{ game.title }}">
    </div>
    {% endif %}

    <div class="game-description-full">
        <h3>–û–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä—ã</h3>
        <p>{{ game.description|linebreaks }}</p>
    </div>

    <!-- –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä—ã -->
    {% if user.is_authenticated and game.status == 'approved' %}
    <div class="game-rating-section">
        <h3>–û—Ü–µ–Ω–∏—Ç–µ –∏–≥—Ä—É</h3>

        <form method="post" action="{% url 'rate_game' game.pk %}" class="rating-form">
            {% csrf_token %}

            <div class="rating-stars">
                {% for i in "12345" %}
                    {% with i=i|add:"0" %}
                    <label class="star-label">
                        <input type="radio" name="rating" value="{{ i }}"
                               {% if user_rating == i %}checked{% endif %}>
                        <span class="star">‚òÖ</span>
                    </label>
                    {% endwith %}
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary btn-sm">
                {% if user_rating > 0 %}–ò–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É{% else %}–û—Ü–µ–Ω–∏—Ç—å{% endif %}
            </button>

            {% if average_rating > 0 %}
            <div class="average-rating">
                –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: <strong>{{ average_rating }}</strong> ({{ rating_count }} –æ—Ü–µ–Ω–æ–∫)
            </div>
            {% endif %}
        </form>
    </div>
    {% elif game.status == 'approved' %}
    <div class="rating-notice">
        <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –∏–≥—Ä—É</p>

        {% if average_rating > 0 %}
        <div class="average-rating">
            –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: <strong>{{ average_rating }}</strong> ({{ rating_count }} –æ—Ü–µ–Ω–æ–∫)
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- –õ–∞–π–∫–∏/–î–∏–∑–ª–∞–π–∫–∏ -->
    {% if game.status == 'approved' %}
    <div class="like-section">
        <button class="like-btn" data-game-id="{{ game.pk }}" data-action="like">
            üëç <span class="like-count">{{ game.stats.likes|default:0 }}</span>
        </button>
        <button class="dislike-btn" data-game-id="{{ game.pk }}" data-action="dislike">
            üëé <span class="dislike-count">{{ game.stats.dislikes|default:0 }}</span>
        </button>
    </div>
    {% endif %}

    {% if game.status == 'approved' %}
    <div class="game-play">
        <h3>–ò–≥—Ä–∞—Ç—å</h3>
        <div class="play-header">
            <button class="btn btn-success btn-sm" id="increment-play">
                üéÆ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É
            </button>
            <span class="play-count">–ó–∞–ø—É—Å–∫–æ–≤: {{ game.get_play_count }}</span>
        </div>

        <iframe
            src="{{ game.html_file.url }}"
            class="game-iframe"
            id="game-frame"
            title="{{ game.title }}"
            sandbox="allow-scripts allow-same-origin"
            style="display: none;"
        ></iframe>

        <div id="game-placeholder" class="game-placeholder">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å</p>
        </div>

        <p class="iframe-note">
            –ï—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è,
            <a href="{{ game.html_file.url }}" target="_blank">–æ—Ç–∫—Ä–æ–π—Ç–µ –µ–µ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ</a>
        </p>
    </div>
    {% elif game.status == 'pending' %}
    <div class="game-waiting">
        <div class="alert alert-info">
            <h3>‚è≥ –ò–≥—Ä–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
            <p>–≠—Ç–∞ –∏–≥—Ä–∞ –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –æ–Ω–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.</p>

            {% if user == game.developer %}
                <p>–í—ã –º–æ–∂–µ—Ç–µ <a href="{% url 'game_edit' game.pk %}">–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É</a> –ø–æ–∫–∞ –æ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ.</p>
            {% endif %}
        </div>
    </div>
    {% elif game.status == 'rejected' %}
    <div class="game-rejected">
        <div class="alert alert-error">
            <h3>‚ùå –ò–≥—Ä–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</h3>
            <p>–≠—Ç–∞ –∏–≥—Ä–∞ –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞.</p>

            {% if user == game.developer %}
                <p>–í—ã –º–æ–∂–µ—Ç–µ <a href="{% url 'game_edit' game.pk %}">–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—É</a> –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    {% if game.status == 'approved' %}
    <div class="comments-section">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})</h3>

        {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' game.pk %}" class="comment-form">
            {% csrf_token %}
            {{ comment_form.text }}
            <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </form>
        {% else %}
        <p class="auth-notice">
            <a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        </p>
        {% endif %}

        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment" id="comment-{{ comment.pk }}">
                <div class="comment-header">
                    <div class="comment-author">
                        {% if comment.user.avatar %}
                            <img src="{{ comment.user.avatar.url }}" alt="{{ comment.user.username }}" class="comment-avatar">
                        {% else %}
                            <div class="comment-avatar-placeholder">
                                {{ comment.user.username|first|upper }}
                            </div>
                        {% endif %}
                        <div class="author-info">
                            <a href="{% url 'user_detail' comment.user.pk %}" class="author-name">
                                {{ comment.user.username }}
                            </a>
                            <span class="comment-date">
                                {{ comment.created_at|date:"d.m.Y H:i" }}
                                {% if comment.is_edited %}
                                    (—Ä–µ–¥.)
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    {% if user == comment.user or user.is_admin or user == game.developer %}
                    <div class="comment-actions">
                        {% if user == comment.user %}
                            <button class="btn-edit-comment btn-link" data-comment-id="{{ comment.pk }}">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        {% endif %}

                        <form method="post" action="{% url 'delete_comment' comment.pk %}"
                              class="delete-comment-form"
                              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?');">
                            {% csrf_token %}
                            <button type="submit" class="btn-link text-danger">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                    {% endif %}
                </div>

                <div class="comment-text" id="comment-text-{{ comment.pk }}">
                    {{ comment.text|linebreaks }}
                </div>

                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞) -->
                {% if user == comment.user %}
                <form method="post" action="{% url 'edit_comment' comment.pk %}"
                      class="edit-comment-form" id="edit-form-{{ comment.pk }}" style="display: none;">
                    {% csrf_token %}
                    <textarea name="text" rows="3" class="edit-textarea">{{ comment.text }}</textarea>
                    <div class="edit-actions">
                        <button type="submit" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-edit"
                                data-comment-id="{{ comment.pk }}">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <div class="no-comments">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="game-actions">
        <a href="{% url 'game_list' %}" class="btn btn-secondary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>

        {% if can_edit %}
            <a href="{% url 'game_edit' game.pk %}" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        {% endif %}

        {% if can_delete %}
            <a href="{% url 'game_delete' game.pk %}" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
        {% endif %}
    </div>
</div>
{% endblock %}